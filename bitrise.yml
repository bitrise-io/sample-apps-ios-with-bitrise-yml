format_version: 0.9.9
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git
app:
  envs:
  - PROJECT_TITLE: BitriseSampleWithYML
    opts:
      is_expand: no
  - XCODE_PROJECT_PATH: ./${PROJECT_TITLE}.xcodeproj
    opts:
      is_expand: yes
  - XCODE_PROJECT_SCHEME: ${PROJECT_TITLE}
    opts:
      is_expand: yes
workflows:

  _download_certs:
    steps:
    - git::https://github.com/bitrise-io/steps-certificate-and-profile-installer.git@master:
        run_if: .IsCI
        inputs:
        - certificate_url: $BITRISE_CERTIFICATE_URL
        - certificate_passphrase: $BITRISE_CERTIFICATE_PASSPHRASE
          opts:
            is_expand: yes
        - provisioning_profile_url: $BITRISE_PROVISION_URL

  test:
    steps:
    - new-xcode-test@0.9.1:
        inputs:
        - project_path: ${XCODE_PROJECT_PATH}
          opts:
            is_expand: yes
        - scheme: ${XCODE_PROJECT_SCHEME}
          opts:
            is_expand: yes
        - simulator_device: iPhone 6
        - simulator_os_version: latest

  analyze:
    before_run:
    - _download_certs
    steps:
    - script:
        inputs:
        - content: |
            #!/bin/bash
            set -v
            set -e
            xcodebuild -project "${XCODE_PROJECT_PATH}" -scheme "${XCODE_PROJECT_SCHEME}" analyze

  archive:
    before_run:
    - test
    - _download_certs
    steps:
    - new-xcode-archive:
        title: Step Test
        inputs:
        - project_path: ${XCODE_PROJECT_PATH}
        - scheme: ${XCODE_PROJECT_SCHEME}

  master:
    before_run:
      - download_certs
      - test
      - analyze
      - archive
